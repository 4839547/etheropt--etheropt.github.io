{"Market":{"code":"0x606060405260008054600160a060020a0319167318e79a47d8a58bef5aaecbba85ea1420649c64a8178155612b0490819061003990396000f3606060405236156101325760e060020a600035046303406e7681146101345780630a2d31ad146103ca578063155dd5ee146105ac5780631ce30927146105da57806322a421711461063857806328e70c4e146108b7578063460c1a7a146108ff5780635dbbfc4714610a45578063711b487114610b3a57806371ada3fb14610dcf57806372e18c1214610e075780637ae2b5c714610e495780638f28397014610e64578063a26759cb14610e97578063a7033af514610ed8578063c803486b14610fb0578063d392c5a214610fe1578063d4dfadbf14610fe9578063d5544f94146112fc578063d9548e531461130f578063decebbce14611330578063e54aae1314611370578063eddb00d41461168d578063edeb797c146116cf578063f3e0faba146116ed578063fe4667e9146118d1575b005b6119e06004356024356040805160208181018352600080835283518083018552818152845180840186528281528551938401865282845294519394909390929190819081908190819060039080591061018a5750595b9080825280602002602001820160405250965060036040518059106101ac5750595b9080825280602002602001820160405250955060009450600093505b60038510156123375750612710915060009050805b600160005060008c815260200190815260200160002060005060000160005060008b815260200190815260200160002060005060070160005054811015612392576000600160005060008d815260200190815260200160002060005060000160005060008c81526020019081526020016000206000506006016000506000838152602001908152602001600020600050600101600050541180156102d4575082600160005060008d815260200190815260200160002060005060000160005060008c815260200190815260200160002060005060060160005060008381526020019081526020016000206000506000016000505411155b8015610304575060008b81526001602090815260408083208d845282528083208484526006019091529020548490115b156103c25760008b81526001602090815260408083208d845282528083208484526006019091529020548390101561039557600091508150600160005060008c815260200190815260200160002060005060000160005060008b8152602001908152602001600020600050600601600050600082815260200190815260200160002060005060000160005054925082505b60008b81526001602081815260408084208e85528252808420858552600601909152909120015491909101905b6001016101dd565b60408051602480356004818101356020818102868101820190975281865261013296833596939560449501929182919085019084908082843750506040805196358089013560208181028a81018201909452818a529799986064989097506024929092019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a52979998608498909750602492909201955093508392508501908490808284375050604080519635808901356020818102808b018201909452818a5297999860a498909750602492909201955093508392508501908490808284375094965050505050505060008054819081908190600160a060020a03908116339091161415611f885788815260016020526040812093505b8651831015611f885750506001828101805491820190556000818152602084905260409020875188908490811015610002576020908102909101015181558651879084908110156100025790602001906020020151816003016000508190555085838151811015610002579060200190602002015181600101600050819055508483815181101561000257906020019060200201518160020160006101000a815481600160a060020a0302191690830217905550600192909201916104ec565b61013260043533600160a060020a03166000908152600560205260408120541115611cff57611d0233610fb7565b6004356000908152600160208181526040808420602435855282529283902091820154825484516003850154600295909501549181529283019390935281840152600160a060020a0391909116606082015290519081900360800190f35b60408051602480356004818101356020818102868101820190975281865261013296833596939560449501929182919085019084908082843750506040805196358089013560208181028a81018201909452818a529799986064989097506024929092019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a52979998608498909750602492909201955093508392508501908490808284375050604080519635808901356020818102808b018201909452818a5297999860a4989097506024929092019550935083925085019084908082843750505060008a8152600160208190526040822060020154959750955093849350839250829150819060ff16811415611f58575b60008b81526001602081905260409091200154851015611e825760406000818120878252602052206001015487518890879081101561000257906020019060200201516040518083815260200182815260200192505050604051809103902093506001848b87815181101561000257906020019060200201518b88815181101561000257906020019060200201518b8981518110156100025790602001906020020151604051808581526020018460ff1681526020018381526020018281526020019450505050506020604051808303816000866161da5a03f115610002575050604051805190602001509250600160005060008c8152602001908152602001600020600050600001600050600086815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a031683600160a060020a03161415156108ab57600095505b60019490940193610755565b6004356000908152600160209081526040808320600160a060020a03604435168452600301825280832060243584529091529020545b60408051918252519081900360200190f35b6101325b600080805b6002548310156123dd57600091505b60016000506000848152602001908152602001600020600050600101600050548210156123e2575060005b60008381526001602090815260408083208584529091529020600501548110156123ee5733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600401600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a03161415610a3d5760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506004016000506000838152602001908152602001600020600050600101600050819055505b600101610942565b6108ed6004355b600080808080805b60025484101561266e5760008481526001602052604081206002015460ff16141561267e57505060406000818120600160a060020a038816825260030160205290812060010154915081905b60016000506000858152602001908152602001600020600050600101600050548110156126795760016000506000858152602001908152602001600020600050600301600050600088600160a060020a0316815260200190815260200160002060005060000160005060008281526020019081526020016000206000505482019150815082821215610b325781925082505b600101610aa0565b6119e060043560243560408051602081810183526000808352835180830185528181528451808401865282815285519384018652828452945193949093909291908190819081908190600390805910610b905750595b908082528060200260200182016040525096506003604051805910610bb25750595b908082528060200260200182016040525095506000945061271093505b6003851015612337575060009150819050805b600160005060008c815260200190815260200160002060005060000160005060008b815260200190815260200160002060005060050160005054811015612348576000600160005060008d815260200190815260200160002060005060000160005060008c8152602001908152602001600020600050600401600050600083815260200190815260200160002060005060010160005054118015610cd9575082600160005060008d815260200190815260200160002060005060000160005060008c815260200190815260200160002060005060040160005060008381526020019081526020016000206000506000016000505410155b8015610d09575060008b81526001602090815260408083208d845282528083208484526004019091529020548490105b15610dc75760008b81526001602090815260408083208d8452825280832084845260040190915290205483901115610d9a57600091508150600160005060008c815260200190815260200160002060005060000160005060008b8152602001908152602001600020600050600401600050600082815260200190815260200160002060005060000160005054925082505b60008b81526001602081815260408084208e85528252808420858552600401909152909120015491909101905b600101610be2565b6108ed6004356024356000828152600160208181526040808420600160a060020a038616855260030190915290912001545b92915050565b61013260043560243560443560643560008080808061271086068114610e31576127108606909503945b6000612165338b8b8a6000036127108d8d02046118e4565b6108ed6004356024355b60008183101561268a575081610e01565b610132600435600054600160a060020a03908116339091161415611cff5760008054600160a060020a0319168217905550565b61013233600160a060020a031660009081526005602052604081205481901115611caf57604080822054825260036020528120600101805434019055611cff565b6101326004356000805b600083815260016020819052604090912001548110156123dd575060005b600083815260016020908152604080832085845290915290206005015481101561251e57604060008181208382526004016020522060020154600160a060020a03908116339091161415610fa85760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506004016000506000838152602001908152602001600020600050600101600050819055505b600101610f00565b6108ed6004355b600160a060020a03811660009081526005602052604081205481901115611d6257611d6a82610a4c565b6002546108ed565b611a6560043560408051602081810183526000808352835180830185528181528451808401865282815285518085018752838152865180860188528481528751808701895285815288518088018a5286815289518089018b528781528a51808a018c528881528b51998a018c52888a529a51999a969995989497939692959194909390918190819060199080591061107e5750595b9080825280602002602001820160405250975060196040518059106110a05750595b9080825280602002602001820160405250965060196040518059106110c25750595b9080825280602002602001820160405250955060196040518059106110e45750595b9080825280602002602001820160405250945060196040518059106111065750595b81815260209182028101909101604052600254909450600093506000190191505b600082121580156111385750601983105b15611dad5760008281526001602052604081206002015460ff161415611dc3575060005b60008281526001602081905260409091200154811015611dc35780826103e802018884815181101561000257604060008181206020848102909501850195909552858152939092529120600301548851909189918110156100025790602001906020020190908181526020015050600160005060008381526020019081526020016000206000506000016000506000828152602001908152602001600020600050600001600050548684815181101561000257906020019060200201909081815260200150506001600050600083815260200190815260200160002060005060030160005060008f600160a060020a031681526020019081526020016000206000506000016000506000828152602001908152602001600020600050548584815181101561000257906020019060200201909081815260200150506001600050600083815260200190815260200160002060005060030160005060008f600160a060020a0316815260200190815260200160002060005060010160005054848481518110156100025750506020848102860101526001928301920161115c565b611b9b60043560006000611d9b83611337565b6108ed60043560008181526001602052604090206002015460ff165b919050565b6108ed6004355b600160a060020a03811660009081526005602052604081205481901115611d62576040808220548252600360205290206001015461132b565b60408051602081810183526000808352835180830185528181528451808401865282815285518085018752838152865180860188528481528751808701895285815288518088018a5286815289518089018b528781528a51608081018c52888152988901889052888b01889052606089018890529951611bb49a9698959794969395929491939282918291906019908059106114095750595b90808252806020026020018201604052509750601960405180591061142b5750595b90808252806020026020018201604052509650601960405180591061144d5750595b90808252806020026020018201604052509550601960405180591061146f5750595b81815260209182028101909101604052600254909550600094506000190192505b600083121580156114a15750601984105b15611dd05760008381526001602052604081206002015460ff161415611de457600091505b60008381526001602081905260409091200154821015611de457611df18383604080516080818101835260008083526020838101829052838501829052606084810183905285519384018652828452908301829052938201819052928101839052909180805b600087815260016020908152604080832089845290915290206005015481101561297e5760406000818120838252600401602052908120600101541180156115c757508260016000506000898152602001908152602001600020600050600001600050600088815260200190815260200160002060005060040160005060008381526020019081526020016000206000506000016000505410155b1561168557600087815260016020908152604080832089845282528083208484526004019091529020548390111561165857600091508150600160005060008881526020019081526020016000206000506000016000506000878152602001908152602001600020600050600401600050600082815260200190815260200160002060005060000160005054925082505b60008781526001602081815260408084208a85528252808420858552600401909152909120015491909101905b60010161152c565b610132600435602435604435606435600080808080612710860681146116b7576127108606909503945b6000611f93338b8b8a6127108d8d02046000036118e4565b6108ed6004356000818152600160208190526040909120015461132b565b604080516004803580820135602081810285810182019096528185526101329593946024949093850192918291908501908490808284375050604080518735808a013560208181028481018201909552818452989a99604499939850919091019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a529799986064989097506024929092019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a529799986084989097506024929092019550935083925085019084908082843750949650505050505050600080548190819081908190600160a060020a03908116339091161415611f8857600280546001818101835581845260205260408320918201805460ff19169055955093505b8751831015611f8857505060018281018054918201905560008181526020849052604090208851899084908110156100025760209081029091010151815587518890849081101561000257602090810290910101516003820155865187908490811015610002576020908102909101015160018201558551869084908110156100025760209081029091010151600282018054600160a060020a031916909117905560019290920191611823565b6108ed6004356024356044356064356084355b600080808080805b60025484101561264e576040600090812085825260016020526002015460ff16141561266257600092506001600050600085815260200190815260200160002060005060030160005060008c600160a060020a031681526020019081526020016000206000506001016000505491508984141561196857908601905b5090508060005b6000848152600160208190526040909120015481101561265d5760406000818120600160a060020a038e1682526003016020908152828220848352905220549091019089841480156119c057508881145b156119ca57908701905b828212156119d85781925082505b60010161196f565b6040518080602001806020018381038352858181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018381038252848181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f15090500194505050505060405180910390f35b60405180806020018060200180602001806020018060200186810386528b8181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f15090500186810385528a8181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018681038452898181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018681038352888181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018681038252878181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050019a505050505050505050505060405180910390f35b6040805192835260208301919091528051918290030190f35b60405180806020018060200180602001806020018581038552898181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018581038452888181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018581038352878181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018581038252868181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050019850505050505050505060405180910390f35b506004805460019081019182905560008281526003602090815260408083208054600160a060020a0319163390811782559401805434019055600160a060020a0393909316825260059052208190555b50565b8113611cff5733600160a060020a031660009081526005602090815260408083205483526003909152902060010180548290039055611d3f610903565b60405133600160a060020a031690600090839082818181858883f1505050505050565b50600061132b565b600160a060020a0383166000908152600560209081526040808320548352600390915290206001015401905061132b565b611da484610fb7565b91509150915091565b50959c949b509299509097509550909350505050565b6000199190910190611127565b50959a949950929750909550919350505050565b6000199290920191611490565b90508060000151888581518110156100025760208181029092018201929092528201518851909189918110156100025790602001906020020190908181526020015050806040015186858151811015610002579060200190602002019090818152602001505080606001518585815181101561000257505060208581028701015260019384019391909101906114c6565b8515611f5857600191505b6004548211611f38575060008a8152600160208181526040808420858552600380845282862054600160a060020a0316865201909152822001549094505b60008b81526001602081905260409091200154851015611f6557604060008181208482526003602081815284842054600160a060020a0316845291018152828220888352905220548751889087908110156100025760209081029091010151020160019490940193611ecb565b60008b8152600160208190526040909120600201805460ff191690911790555b5050505050505050505050565b600082815260036020526040902060010180548201905560019190910190611e8d565b505050505050505050565b611f9c33611337565b011315611f8857600194505b848015611fb55750600086115b156120b3576000199350600092505b60008981526001602090815260408083208b84529091529020600701548310156121115760406000818120858252600601602052205487901180159061205d57506000600160005060008b815260200190815260200160002060005060000160005060008a8152602001908152602001600020600050600601600050600085815260200190815260200160002060005060010160005054115b801561209c5750600084128061209c575060008981526001602090815260408083208b8452825280832087845260060190915280822054858352912054105b156120a75782935083505b60019290920191611fc4565b6000861115611f8857505050600095865250506001602081815260408087209587529481528486206005810180548085019091558752600401905292909320908155908101919091556002018054600160a060020a03191633179055565b60008412156121235760009450612160565b61215d8989898988600085815260016020818152604080842088855282528084208585526006019091528220015481906126c69085610e53565b95505b611fa8565b61216e33611337565b011315611f8857600194505b8480156121875750600086115b15612285576000199350600092505b60008981526001602090815260408083208b84529091529020600501548310156122e35760406000818120858252600401602052205487901080159061222f57506000600160005060008b815260200190815260200160002060005060000160005060008a8152602001908152602001600020600050600401600050600085815260200190815260200160002060005060010160005054115b801561226e5750600084128061226e575060008981526001602090815260408083208b8452825280832087845260040190915280822054858352912054115b156122795782935083505b60019290920191612196565b6000861115611f8857505050600095865250506001602081815260408087209587529481528486206007810180548085019091558752600601905292909320908155908101919091556002018054600160a060020a03191633179055565b60008412156122f55760009450612332565b61232f89898989886000858152600160208181526040808420888552825280842085855260040190915282200154819061280b9085610e53565b95505b61217a565b509499939850929650505050505050565b600083111561238657829350835082878681518110156100025760209081029091010152855182908790879081101561000257602090810290910101525b60019490940193610bcf565b6127108310156123d157829350835082878681518110156100025760209081029091010152855182908790879081101561000257602090810290910101525b600194909401936101c8565b505050565b60019290920191610908565b5060005b600160005060008481526020019081526020016000206000506000016000506000838152602001908152602001600020600050600701600050548110156125125733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600601600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a0316141561250a5760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506006016000506000838152602001908152602001600020600050600101600050819055505b6001016123f2565b60019190910190610917565b5060005b600160005060008481526020019081526020016000206000506000016000506000838152602001908152602001600020600050600701600050548110156126425733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600601600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a0316141561263a5760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506006016000506000838152602001908152602001600020600050600101600050819055505b600101612522565b60019190910190610ee2565b50929998505050505050505050565b938201935b600193909301926118ec565b509295945050505050565b938201935b60019390930192610a54565b5080610e01565b60008781526001602081815260408084208a85528252808420878552600601909152822001555b8391505b5095945050505050565b60008881526001602090815260408083208a845282528083208784526006019091528120805460029190910154929350909161271d91600160a060020a0391909116908a908a9086860390612710908802046118e4565b60008981526001602090815260408083208b8452825280832088845260060190915290206002015461275790600160a060020a0316611337565b01131561269157600087815260016020818152604080842033600160a060020a039081168652600382018085528387208d885280865284882080548a0190559285528387208a8852600601855283872080549387018054612710958b028690049003905580870180548a90039055600281018054841689528287528589208f8a52875285892080548b90039055905490549092168752909352932090910180549184029290920401905592839003926126b8565b60008881526001602090815260408083208a845282528083208784526004019091528120805460029190910154929350909161286291600160a060020a0391909116908a908a9086906127109082020486036118e4565b60008981526001602090815260408083208b8452825280832088845260040190915290206002015461289c90600160a060020a0316611337565b01131561295057600087815260016020818152604080842033600160a060020a039081168652600382018085528387208d885280865284882080548a900390559285528387208a8852600401855283872080549387018054612710958b0286900401905580870180548a90039055600281018054841689528287528589208f8a52875285892080548b01905590549054909216875290935293209091018054918402929092049003905592839003926126b8565b60008781526001602081815260408084208a85528252808420878552600401909152822001558391506126bc565b5090825260208201526127106000805b6000878152600160209081526040808320898452909152902060070154811015612aef576040600081812083825260060160205290812060010154118015612a2957508260016000506000898152602001908152602001600020600050600001600050600088815260200190815260200160002060005060060160005060008381526020019081526020016000206000506000016000505411155b15612ae7576000878152600160209081526040808320898452825280832084845260060190915290205483901015612aba57600091508150600160005060008881526020019081526020016000206000506000016000506000878152602001908152602001600020600050600601600050600082815260200190815260200160002060005060000160005054925082505b60008781526001602081815260408084208a85528252808420858552600601909152909120015491909101905b60010161298e565b5060408301919091526060820152939250505056","info":{"source":"contract Market {\n\n  address admin = 0x18e79a47d8a58bef5aaecbba85ea1420649c64a8;\n\n  struct Order {\n    uint price;\n    uint size;\n    address user;\n  }\n  struct Option {\n    uint id;\n    bytes32 factHash;\n    address ethAddr;\n    uint strike;\n    mapping(uint => Order) buyOrders;\n    uint numBuyOrders;\n    mapping(uint => Order) sellOrders;\n    uint numSellOrders;\n  }\n  struct TopLevel {\n    uint buyPrice;\n    uint buySize;\n    uint sellPrice;\n    uint sellSize;\n  }\n  struct Position {\n    mapping(uint => int) positions;\n    int cash;\n  }\n  struct OptionChain {\n    mapping(uint => Option) options;\n    uint numOptions;\n    bool expired;\n    mapping(address => Position) positions;\n  }\n  mapping(uint => OptionChain) optionChains;\n  uint numOptionChains;\n  struct Account {\n    address user;\n    int capital;\n  }\n  mapping(uint => Account) accounts;\n  uint numAccounts;\n  mapping(address => uint) accountIDs; //starts at 1\n\n  function addFunds() {\n    if (accountIDs[msg.sender]>0) {\n      accounts[accountIDs[msg.sender]].capital += int(msg.value);\n    } else {\n      uint accountID = ++numAccounts;\n      accounts[accountID].user = msg.sender;\n      accounts[accountID].capital += int(msg.value);\n      accountIDs[msg.sender] = accountID;\n    }\n  }\n\n  function withdrawFunds(uint amount) {\n    if (accountIDs[msg.sender]>0) {\n      if (int(amount)<=getAvailableFunds(msg.sender)) {\n        accounts[accountIDs[msg.sender]].capital -= int(amount);\n        cancelOrders();\n        msg.sender.send(amount);\n      }\n    }\n  }\n\n  function getFunds(address user) constant returns(int) {\n    if (accountIDs[user]>0) {\n      return accounts[accountIDs[user]].capital;\n    } else {\n      return 0;\n    }\n  }\n\n  function getAvailableFunds(address user) constant returns(int) {\n    if (accountIDs[user]>0) {\n      return accounts[accountIDs[user]].capital + getMaxLoss(user);\n    } else {\n      return 0;\n    }\n  }\n\n  function getFundsAndAvailable(address user) constant returns(int, int) {\n    return (getFunds(user), getAvailableFunds(user));\n  }\n\n  function getMarket(address user) constant returns(uint[], uint[], uint[], int[], int[]) {\n    uint[] memory optionIDs = new uint[](25);\n    uint[] memory strikes = new uint[](25);\n    uint[] memory ids = new uint[](25);\n    int[] memory positions = new int[](25);\n    int[] memory cashes = new int[](25);\n    uint z = 0;\n    for (int optionChainID=int(numOptionChains)-1; optionChainID>=0 && z<25; optionChainID--) {\n      if (optionChains[uint(optionChainID)].expired == false) {\n        for (uint optionID=0; optionID<optionChains[uint(optionChainID)].numOptions; optionID++) {\n          optionIDs[z] = uint(optionChainID)*1000 + optionID;\n          strikes[z] = optionChains[uint(optionChainID)].options[optionID].strike;\n          ids[z] = optionChains[uint(optionChainID)].options[optionID].id;\n          positions[z] = optionChains[uint(optionChainID)].positions[user].positions[optionID];\n          cashes[z] = optionChains[uint(optionChainID)].positions[user].cash;\n          z++;\n        }\n      }\n    }\n    return (optionIDs, strikes, ids, positions, cashes);\n  }\n\n  function getMarketTopLevels() returns(uint[], uint[], uint[], uint[]) {\n    uint[] memory buyPrices = new uint[](25);\n    uint[] memory buySizes = new uint[](25);\n    uint[] memory sellPrices = new uint[](25);\n    uint[] memory sellSizes = new uint[](25);\n    uint z = 0;\n    for (int optionChainID=int(numOptionChains)-1; optionChainID>=0 && z<25; optionChainID--) {\n      if (optionChains[uint(optionChainID)].expired == false) {\n        for (uint optionID=0; optionID<optionChains[uint(optionChainID)].numOptions; optionID++) {\n          TopLevel memory topLevel = getTopLevel(uint(optionChainID), optionID);\n          buyPrices[z] = topLevel.buyPrice;\n          buySizes[z] = topLevel.buySize;\n          sellPrices[z] = topLevel.sellPrice;\n          sellSizes[z] = topLevel.sellSize;\n          z++;\n        }\n      }\n    }\n    return (buyPrices, buySizes, sellPrices, sellSizes);\n  }\n\n  function expire(uint optionChainID, uint8[] v, bytes32[] r, bytes32[] s, uint256[] value) {\n    bool allSigned = true;\n    if (optionChains[optionChainID].expired == false) {\n      for (uint optionID=0; optionID<optionChains[optionChainID].numOptions; optionID++) {\n        var hash = sha3(optionChains[optionChainID].options[optionID].factHash, value[optionID]);\n        var signerAddress = ecrecover(hash, v[optionID], r[optionID], s[optionID]);\n        if (signerAddress != optionChains[optionChainID].options[optionID].ethAddr) {\n          allSigned = false;\n        }\n      }\n      if (allSigned) {\n        for (uint accountID=1; accountID<=numAccounts; accountID++) {\n          int result = optionChains[optionChainID].positions[accounts[accountID].user].cash;\n          for (optionID=0; optionID<optionChains[optionChainID].numOptions; optionID++) {\n            result += (int(value[optionID]) * optionChains[optionChainID].positions[accounts[accountID].user].positions[optionID]);\n          }\n          accounts[accountID].capital = accounts[accountID].capital + result;\n        }\n        optionChains[optionChainID].expired = true;\n      }\n    }\n  }\n\n  function addOptionChain(uint[] ids, uint[] strikes, bytes32[] factHashes, address[] ethAddrs) {\n    if (msg.sender==admin) {\n      var optionChainID = numOptionChains++;\n      OptionChain optionChain = optionChains[optionChainID];\n      optionChain.expired = false;\n      for (uint i=0; i < strikes.length; i++) {\n        var optionID = optionChain.numOptions++;\n        Option option = optionChain.options[optionID];\n        option.id = ids[i];\n        option.strike = strikes[i];\n        option.factHash = factHashes[i];\n        option.ethAddr = ethAddrs[i];\n      }\n    }\n  }\n\n  function addToOptionChain(uint optionChainID, uint[] ids, uint[] strikes, bytes32[] factHashes, address[] ethAddrs) {\n    if (msg.sender==admin) {\n      OptionChain optionChain = optionChains[optionChainID];\n      for (uint i=0; i < strikes.length; i++) {\n        var optionID = optionChain.numOptions++;\n        Option option = optionChain.options[optionID];\n        option.id = ids[i];\n        option.strike = strikes[i];\n        option.factHash = factHashes[i];\n        option.ethAddr = ethAddrs[i];\n      }\n    }\n  }\n\n  function isExpired(uint optionChainID) constant returns(bool) {\n    return optionChains[optionChainID].expired;\n  }\n  function getNumOptionChains() constant returns(uint) {\n    return numOptionChains;\n  }\n  function getNumOptions(uint optionChainID) constant returns(uint) {\n    return optionChains[optionChainID].numOptions;\n  }\n  function getOption(uint optionChainID, uint optionID) constant returns(uint, uint, bytes32, address) {\n    return (optionChains[optionChainID].options[optionID].id, optionChains[optionChainID].options[optionID].strike, optionChains[optionChainID].options[optionID].factHash, optionChains[optionChainID].options[optionID].ethAddr);\n  }\n  function getPosition(uint optionChainID, uint optionID, address user) constant returns(int) {\n    return optionChains[optionChainID].positions[user].positions[optionID];\n  }\n  function getCash(uint optionChainID, address user) constant returns(int) {\n    return optionChains[optionChainID].positions[user].cash;\n  }\n\n  function placeBuyOrder(uint optionChainID, uint optionID, uint price, uint size) {\n    if (size % 10000 != 0) {\n      size -= size % 10000;\n    }\n    if (getFunds(msg.sender)+getMaxLossAfterTrade(msg.sender, optionChainID, optionID, int(size), -int(size * price / 10000))>0) {\n      bool foundMatch = true;\n      while (foundMatch && size>0) {\n        int256 bestPriceID = -1;\n        for (uint256 i=0; i<optionChains[optionChainID].options[optionID].numSellOrders; i++) {\n          if (optionChains[optionChainID].options[optionID].sellOrders[i].price<=price && optionChains[optionChainID].options[optionID].sellOrders[i].size>0 && (bestPriceID<0 || optionChains[optionChainID].options[optionID].sellOrders[i].price<optionChains[optionChainID].options[optionID].sellOrders[uint(bestPriceID)].price)) {\n            bestPriceID = int(i);\n          }\n        }\n        if (bestPriceID<0) {\n          foundMatch = false;\n        } else {\n          size = orderMatchBuy(optionChainID, optionID, price, size, uint(bestPriceID));\n        }\n      }\n      if (size>0) {\n        uint orderID = optionChains[optionChainID].options[optionID].numBuyOrders++;\n        Order order = optionChains[optionChainID].options[optionID].buyOrders[orderID];\n        order.price = price;\n        order.size = size;\n        order.user = msg.sender;\n      }\n    }\n  }\n\n  function placeSellOrder(uint optionChainID, uint optionID, uint price, uint size) {\n    if (size % 10000 != 0) {\n      size -= size % 10000;\n    }\n    if (getFunds(msg.sender)+getMaxLossAfterTrade(msg.sender, optionChainID, optionID, -int(size), int(size * price / 10000))>0) {\n      bool foundMatch = true;\n      while (foundMatch && size>0) {\n        int256 bestPriceID = -1;\n        for (uint256 i=0; i<optionChains[optionChainID].options[optionID].numBuyOrders; i++) {\n          if (optionChains[optionChainID].options[optionID].buyOrders[i].price>=price && optionChains[optionChainID].options[optionID].buyOrders[i].size>0 && (bestPriceID<0 || optionChains[optionChainID].options[optionID].buyOrders[i].price>optionChains[optionChainID].options[optionID].buyOrders[uint(bestPriceID)].price)) {\n            bestPriceID = int(i);\n          }\n        }\n        if (bestPriceID<0) {\n          foundMatch = false;\n        } else {\n          size = orderMatchSell(optionChainID, optionID, price, size, uint(bestPriceID));\n        }\n      }\n      if (size>0) {\n        uint orderID = optionChains[optionChainID].options[optionID].numSellOrders++;\n        Order order = optionChains[optionChainID].options[optionID].sellOrders[orderID];\n        order.price = price;\n        order.size = size;\n        order.user = msg.sender;\n      }\n    }\n  }\n\n  function orderMatchBuy(uint optionChainID, uint optionID, uint price, uint size, uint bestPriceID) private returns(uint) {\n    uint sizeChange = min(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].size, size);\n    if (getFunds(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user)+getMaxLossAfterTrade(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user, optionChainID, optionID, -int(sizeChange), int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000))>0) {\n      size -= sizeChange;\n      optionChains[optionChainID].positions[msg.sender].positions[optionID] += int(sizeChange);\n      optionChains[optionChainID].positions[msg.sender].cash -= int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000);\n      optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].size -= sizeChange;\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user].positions[optionID] -= int(sizeChange);\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user].cash += int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000);\n    } else {\n      optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].size = 0;\n    }\n    return size;\n  }\n\n  function orderMatchSell(uint optionChainID, uint optionID, uint price, uint size, uint bestPriceID) private returns(uint) {\n    uint sizeChange = min(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].size, size);\n    if (getFunds(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user)+getMaxLossAfterTrade(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user, optionChainID, optionID, int(sizeChange), -int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000))>0) {\n      size -= sizeChange;\n      optionChains[optionChainID].positions[msg.sender].positions[optionID] -= int(sizeChange);\n      optionChains[optionChainID].positions[msg.sender].cash += int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000);\n      optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].size -= sizeChange;\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user].positions[optionID] += int(sizeChange);\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user].cash -= int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000);\n    } else {\n      optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].size = 0;\n    }\n    return size;\n  }\n\n  function getOptionBuyOrders(uint optionChainID, uint optionID) constant returns(uint[], uint[]) {\n    uint[] memory buyPrices = new uint[](3);\n    uint[] memory buySizes = new uint[](3);\n    uint z = 0;\n    uint bestLevel = 10000;\n    while (z<3) {\n      uint watermark = 0;\n      uint size = 0;\n      for (uint i=0; i<optionChains[optionChainID].options[optionID].numBuyOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].buyOrders[i].size>0 && optionChains[optionChainID].options[optionID].buyOrders[i].price>=watermark && optionChains[optionChainID].options[optionID].buyOrders[i].price<bestLevel) {\n          if (optionChains[optionChainID].options[optionID].buyOrders[i].price>watermark) {\n            size = 0;\n            watermark = optionChains[optionChainID].options[optionID].buyOrders[i].price;\n          }\n          size += optionChains[optionChainID].options[optionID].buyOrders[i].size;\n        }\n      }\n      if (watermark>0) {\n        bestLevel = watermark;\n        buyPrices[z] = watermark;\n        buySizes[z] = size;\n      }\n      z = z + 1;\n    }\n    return (buyPrices, buySizes);\n  }\n\n  function getOptionSellOrders(uint optionChainID, uint optionID) constant returns(uint[], uint[]) {\n    uint[] memory sellPrices = new uint[](3);\n    uint[] memory sellSizes = new uint[](3);\n    uint z = 0;\n    uint bestLevel = 0;\n    while (z<3) {\n      uint watermark = 10000;\n      uint size = 0;\n      for (uint i=0; i<optionChains[optionChainID].options[optionID].numSellOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].sellOrders[i].size>0 && optionChains[optionChainID].options[optionID].sellOrders[i].price<=watermark && optionChains[optionChainID].options[optionID].sellOrders[i].price>bestLevel) {\n          if (optionChains[optionChainID].options[optionID].sellOrders[i].price<watermark) {\n            size = 0;\n            watermark = optionChains[optionChainID].options[optionID].sellOrders[i].price;\n          }\n          size += optionChains[optionChainID].options[optionID].sellOrders[i].size;\n        }\n      }\n      if (watermark<10000) {\n        bestLevel = watermark;\n        sellPrices[z] = watermark;\n        sellSizes[z] = size;\n      }\n      z = z + 1;\n    }\n    return (sellPrices, sellSizes);\n  }\n\n  function getTopLevel(uint optionChainID, uint optionID) private constant returns(TopLevel) {\n    TopLevel memory topLevel;\n    uint watermark = 0;\n    uint size = 0;\n    for (uint i=0; i<optionChains[optionChainID].options[optionID].numBuyOrders; i++) {\n      if (optionChains[optionChainID].options[optionID].buyOrders[i].size>0 && optionChains[optionChainID].options[optionID].buyOrders[i].price>=watermark) {\n        if (optionChains[optionChainID].options[optionID].buyOrders[i].price>watermark) {\n          size = 0;\n          watermark = optionChains[optionChainID].options[optionID].buyOrders[i].price;\n        }\n        size += optionChains[optionChainID].options[optionID].buyOrders[i].size;\n      }\n    }\n    topLevel.buyPrice = watermark;\n    topLevel.buySize = size;\n    watermark = 10000;\n    size = 0;\n    for (i=0; i<optionChains[optionChainID].options[optionID].numSellOrders; i++) {\n      if (optionChains[optionChainID].options[optionID].sellOrders[i].size>0 && optionChains[optionChainID].options[optionID].sellOrders[i].price<=watermark) {\n        if (optionChains[optionChainID].options[optionID].sellOrders[i].price<watermark) {\n          size = 0;\n          watermark = optionChains[optionChainID].options[optionID].sellOrders[i].price;\n        }\n        size += optionChains[optionChainID].options[optionID].sellOrders[i].size;\n      }\n    }\n    topLevel.sellPrice = watermark;\n    topLevel.sellSize = size;\n    return topLevel;\n  }\n\n  function cancelOrders() {\n    for (uint optionChainID=0; optionChainID<numOptionChains; optionChainID++) {\n      for (uint i=0; i<optionChains[optionChainID].numOptions; i++) {\n        for (uint j=0; j<optionChains[optionChainID].options[i].numBuyOrders; j++) {\n          if (optionChains[optionChainID].options[i].buyOrders[j].user==msg.sender) {\n            optionChains[optionChainID].options[i].buyOrders[j].size = 0;\n          }\n        }\n        for (j=0; j<optionChains[optionChainID].options[i].numSellOrders; j++) {\n          if (optionChains[optionChainID].options[i].sellOrders[j].user==msg.sender) {\n            optionChains[optionChainID].options[i].sellOrders[j].size = 0;\n          }\n        }\n      }\n    }\n  }\n\n  function cancelOrdersOnChain(uint optionChainID) {\n    for (uint i=0; j<optionChains[optionChainID].numOptions; i++) {\n      for (uint j=0; j<optionChains[optionChainID].options[i].numBuyOrders; j++) {\n        if (optionChains[optionChainID].options[i].buyOrders[j].user==msg.sender) {\n          optionChains[optionChainID].options[i].buyOrders[j].size = 0;\n        }\n      }\n      for (j=0; j<optionChains[optionChainID].options[i].numSellOrders; j++) {\n        if (optionChains[optionChainID].options[i].sellOrders[j].user==msg.sender) {\n          optionChains[optionChainID].options[i].sellOrders[j].size = 0;\n        }\n      }\n    }\n  }\n\n  function getMaxLossAfterTrade(address user, uint optionChainID, uint optionID, int positionChange, int cashChange) constant returns(int) {\n    int totalMaxLoss = 0;\n    for (uint i=0; i<numOptionChains; i++) {\n      if (optionChains[i].expired == false) {\n        int maxLoss = 0;\n        int pnl = optionChains[i].positions[user].cash;\n        if (i==optionChainID) {\n          pnl += cashChange;\n        }\n        maxLoss = pnl;\n        for (uint j=0; j<optionChains[i].numOptions; j++) {\n          pnl += optionChains[i].positions[user].positions[j];\n          if (i==optionChainID && j==optionID) {\n            pnl += positionChange;\n          }\n          if (pnl<maxLoss) {\n            maxLoss = pnl;\n          }\n        }\n        totalMaxLoss += maxLoss;\n      }\n    }\n    return totalMaxLoss;\n  }\n\n  function getMaxLoss(address user) constant returns(int) {\n    int totalMaxLoss = 0;\n    for (uint i=0; i<numOptionChains; i++) {\n      if (optionChains[i].expired == false) {\n        int maxLoss = 0;\n        int pnl = optionChains[i].positions[user].cash;\n        maxLoss = pnl;\n        for (uint j=0; j<optionChains[i].numOptions; j++) {\n          pnl += optionChains[i].positions[user].positions[j];\n          if (pnl<maxLoss) {\n            maxLoss = pnl;\n          }\n        }\n        totalMaxLoss += maxLoss;\n      }\n    }\n    return totalMaxLoss;\n  }\n\n  function changeAdmin(address newAdmin) {\n    if (msg.sender == admin) {\n      admin = newAdmin;\n    }\n  }\n\n  function min(uint a, uint b) constant returns(uint) {\n    if (a<b) {\n      return a;\n    } else {\n      return b;\n    }\n  }\n}\n","language":"Solidity","languageVersion":"0.2.0","compilerVersion":"0.2.0","compilerOptions":"--bin --abi --userdoc --devdoc --add-std --optimize -o /var/folders/sj/bz257rsj0w1g7cpjjycd7wpw0000gn/T/solc111862118","abiDefinition":[{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOptionSellOrders","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"ids","type":"uint256[]"},{"name":"strikes","type":"uint256[]"},{"name":"factHashes","type":"bytes32[]"},{"name":"ethAddrs","type":"address[]"}],"name":"addToOptionChain","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"amount","type":"uint256"}],"name":"withdrawFunds","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOption","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"},{"name":"","type":"bytes32"},{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"v","type":"uint8[]"},{"name":"r","type":"bytes32[]"},{"name":"s","type":"bytes32[]"},{"name":"value","type":"uint256[]"}],"name":"expire","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"user","type":"address"}],"name":"getPosition","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[],"name":"cancelOrders","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getMaxLoss","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOptionBuyOrders","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"user","type":"address"}],"name":"getCash","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"price","type":"uint256"},{"name":"size","type":"uint256"}],"name":"placeSellOrder","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"min","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"newAdmin","type":"address"}],"name":"changeAdmin","outputs":[],"type":"function"},{"constant":false,"inputs":[],"name":"addFunds","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"}],"name":"cancelOrdersOnChain","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getAvailableFunds","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":true,"inputs":[],"name":"getNumOptionChains","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getMarket","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"},{"name":"","type":"int256[]"},{"name":"","type":"int256[]"}],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getFundsAndAvailable","outputs":[{"name":"","type":"int256"},{"name":"","type":"int256"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"}],"name":"isExpired","outputs":[{"name":"","type":"bool"}],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getFunds","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[],"name":"getMarketTopLevels","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"price","type":"uint256"},{"name":"size","type":"uint256"}],"name":"placeBuyOrder","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"}],"name":"getNumOptions","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"ids","type":"uint256[]"},{"name":"strikes","type":"uint256[]"},{"name":"factHashes","type":"bytes32[]"},{"name":"ethAddrs","type":"address[]"}],"name":"addOptionChain","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"},{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"positionChange","type":"int256"},{"name":"cashChange","type":"int256"}],"name":"getMaxLossAfterTrade","outputs":[{"name":"","type":"int256"}],"type":"function"}],"userDoc":{"methods":{}},"developerDoc":{"methods":{}}}}}