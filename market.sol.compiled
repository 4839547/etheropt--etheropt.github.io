{"Market":{"code":"0x606060405260008054600160a060020a0319167318e79a47d8a58bef5aaecbba85ea1420649c64a8178155611dde90819061003990396000f3606060405236156100f05760e060020a600035046303406e7681146100f25780631ce309271461038757806322a42171146103e557806328e70c4e14610664578063460c1a7a146106ac5780635dbbfc47146107f15780636d5433e6146108f6578063711b48711461091057806371ada3fb14610ba457806372e18c1214610bdc5780637ae2b5c714610d16578063a26759cb14610d31578063a7033af514610d72578063c803486b14610e4a578063d392c5a214610e7a578063decebbce14610e82578063eddb00d414610ec2578063edeb797c14611078578063f3e0faba14611097578063fe4667e91461127b575b005b611397600435602435604080516020818101835260008083528351808301855281815284518084018652828152855193840186528284529451939490939092919081908190819081906003908059106101485750595b90808252806020026020018201604052509650600360405180591061016a5750595b9080825280602002602001820160405250955060009450600093505b600385101561173f5750612710915060009050805b600160005060008c815260200190815260200160002060005060000160005060008b81526020019081526020016000206000506007016000505481101561179a576000600160005060008d815260200190815260200160002060005060000160005060008c8152602001908152602001600020600050600601600050600083815260200190815260200160002060005060010160005054118015610292575082600160005060008d815260200190815260200160002060005060000160005060008c815260200190815260200160002060005060060160005060008381526020019081526020016000206000506000016000505411155b80156102c2575060008b81526001602090815260408083208d845282528083208484526006019091529020548490115b1561037f5760008b81526001602090815260408083208d845282528083208484526006019091529020548390101561035357600091508150600160005060008c815260200190815260200160002060005060000160005060008b8152602001908152602001600020600050600601600050600082815260200190815260200160002060005060000160005054925082505b60008b81526001602081815260408084208e855282528084208585526006019091529091200154909101905b60010161019b565b6004356000908152600160208181526040808420602435855282529283902091820154825484516003850154600295909501549181529283019390935281840152600160a060020a0391909116606082015290519081900360800190f35b6040805160248035600481810135602081810286810182019097528186526100f096833596939560449501929182919085019084908082843750506040805196358089013560208181028a81018201909452818a529799986064989097506024929092019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a52979998608498909750602492909201955093508392508501908490808284375050604080519635808901356020818102808b018201909452818a5297999860a49890975060249290920195509350839250850190849080828437509496505050505050506001600080808080805b60008c815260016020819052604090912001548610156114a8576040600081812088825260205220600101548851600291908a908990811015610002579060200190602002015160405180838152602001828152602001925050506020604051808303816000866161da5a03f1156100025750506040518051906020015094506001858c88815181101561000257906020019060200201518c89815181101561000257906020019060200201518c8a81518110156100025790602001906020020151604051808581526020018460ff1681526020018381526020018281526020019450505050506020604051808303816000866161da5a03f115610002575050604051805190602001509350600160005060008d8152602001908152602001600020600050600001600050600087815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a031684600160a060020a031614151561065857600096505b600195909501946104e3565b6004356000908152600160209081526040808320600160a060020a03604435168452600301825280832060243584529091529020545b60408051918252519081900360200190f35b6100f0600080805b6002548310156117e557600091505b60016000506000848152602001908152602001600020600050600101600050548210156117ea575060005b60008381526001602090815260408083208584529091529020600501548110156117f65733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600401600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a031614156107e95760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506004016000506000838152602001908152602001600020600050600101600050819055505b6001016106ee565b61069a6004355b600080808080805b600254841015611a7b5760008481526001602052604081206002015460ff161415611a905760406000818120600160a060020a038a168252600301602052908120600101549093509150828212156108585781925082505b5060005b6001600050600085815260200190815260200160002060005060010160005054811015611a865760016000506000858152602001908152602001600020600050600301600050600088600160a060020a03168152602001908152602001600020600050600001600050600082815260200190815260200160002060005054820191508150828212156108ee5781925082505b60010161085c565b61069a600435602435600081831115611a9c575081610bd6565b611397600435602435604080516020818101835260008083528351808301855281815284518084018652828152855193840186528284529451939490939092919081908190819081906003908059106109665750595b9080825280602002602001820160405250965060036040518059106109885750595b908082528060200260200182016040525095506000945061271093505b600385101561173f575060009150819050805b600160005060008c815260200190815260200160002060005060000160005060008b815260200190815260200160002060005060050160005054811015611750576000600160005060008d815260200190815260200160002060005060000160005060008c8152602001908152602001600020600050600401600050600083815260200190815260200160002060005060010160005054118015610aaf575082600160005060008d815260200190815260200160002060005060000160005060008c815260200190815260200160002060005060040160005060008381526020019081526020016000206000506000016000505410155b8015610adf575060008b81526001602090815260408083208d845282528083208484526004019091529020548490105b15610b9c5760008b81526001602090815260408083208d8452825280832084845260040190915290205483901115610b7057600091508150600160005060008c815260200190815260200160002060005060000160005060008b8152602001908152602001600020600050600401600050600082815260200190815260200160002060005060000160005054925082505b60008b81526001602081815260408084208e855282528084208585526004019091529091200154909101905b6001016109b8565b61069a6004356024356000828152600160208181526040808420600160a060020a038616855260030190915290912001545b92915050565b6100f060043560243560443560643560008080808061271086068114610c06576127108606909503945b600194505b848015610c185750600086115b1561168d576000199350600092505b60008981526001602090815260408083208b84529091529020600501548310156116eb57604060008181208582526004016020522054879010801590610cc057506000600160005060008b815260200190815260200160002060005060000160005060008a8152602001908152602001600020600050600401600050600085815260200190815260200160002060005060010160005054115b8015610cff57506000841280610cff575060008981526001602090815260408083208b8452825280832087845260040190915280822054858352912054115b15610d0a5782935083505b60019290920191610c27565b61069a6004356024355b600081831015611a9c575081610bd6565b6100f033600160a060020a03166000908152600560205260408120548190111561141c5760408082205482526003602052812060010180543401905561146c565b6100f06004356000805b600083815260016020819052604090912001548110156117e5575060005b600083815260016020908152604080832085845290915290206005015481101561192657604060008181208382526004016020522060020154600160a060020a03908116339091161415610e425760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506004016000506000838152602001908152602001600020600050600101600050819055505b600101610d9a565b61069a600435600160a060020a0381166000908152600560205260408120548190111561146f57611477826107f8565b60025461069a565b61069a6004355b600160a060020a0381166000908152600560205260408120548190111561146f5760408082205482526003602052902060010154611092565b6100f060043560243560443560643560008080808061271086068114610eec576127108606909503945b600194505b848015610efe5750600086115b156115e4576000199350600092505b60008981526001602090815260408083208b845290915290206007015483101561164257604060008181208582526006016020522054879011801590610fa657506000600160005060008b815260200190815260200160002060005060000160005060008a8152602001908152602001600020600050600601600050600085815260200190815260200160002060005060010160005054115b8015611061575060008412806110615750600160005060008a81526020019081526020016000206000506000016000506000898152602001908152602001600020600050600601600050600085815260200190815260200160002060005060000160005054600160005060008b815260200190815260200160002060005060000160005060008a8152602001908152602001600020600050600601600050600085815260200190815260200160002060005060000160005054105b1561106c5782935083505b60019290920191610f0d565b61069a600435600081815260016020819052604090912001545b919050565b604080516004803580820135602081810285810182019096528185526100f09593946024949093850192918291908501908490808284375050604080518735808a013560208181028481018201909552818452989a99604499939850919091019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a529799986064989097506024929092019550935083925085019084908082843750506040805196358089013560208181028a81018201909452818a529799986084989097506024929092019550935083925085019084908082843750949650505050505050600080548190819081908190600160a060020a039081163390911614156115d957600280546001818101835581845260205260408320918201805460ff19169055955093505b87518310156115d957505060018281018054918201905560008181526020849052604090208851899084908110156100025760209081029091010151815587518890849081101561000257602090810290910101516003820155865187908490811015610002576020908102909101015160018201558551869084908110156100025760209081029091010151600282018054600160a060020a0319169091179055600192909201916111cd565b61069a6004356024356044356064356084355b600080808080805b600254841015611a56576040600090812085825260016020526002015460ff161415611a6f57600092506001600050600085815260200190815260200160002060005060030160005060008c600160a060020a03168152602001908152602001600020600050600101600050549150828212156113135781925082505b8984141561132057908601905b5060005b60008481526001602081905260409091200154811015611a655760406000818120600160a060020a038e16825260030160209081528282208483529052205490910190898414801561137557508881145b1561137f57908701905b8282121561138f57600082900392505b600101611324565b6040518080602001806020018381038352858181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f1509050018381038252848181518152602001915080519060200190602002808383829060006004602084601f0104600f02600301f15090500194505050505060405180910390f35b506004805460019081019182905560008281526003602090815260408083208054600160a060020a0319163390811782559401805434019055600160a060020a0393909316825260059052208190555b50565b506000611092565b600160a060020a03831660009081526005602090815260408083205483526003909152902060010154039050611092565b861561159c57600095505b60008c8152600160208190526040909120015486101561157c57600092505b6004548310156115aa57505060008a8152600160208181526040808420858552600380845282862054600160a060020a031686520190915282200154905b60008c815260016020819052604090912001548110156115b657604060008181208582526003602081815284842054600160a060020a03168452910181528282208483529052205488518990839081101561000257602090810290910101510290910190600101611510565b60008c8152600160208190526040909120600201805460ff191690911790555b505050505050505050505050565b600195909501946114b3565b6000838152600360205260409020600101805483019055600192909201916114d2565b505050505050505050565b60008611156115d957505050600095865250506001602081815260408087209587529481528486206005810180548085019091558752600401905292909320908155908101919091556002018054600160a060020a03191633179055565b60008412156116545760009450611688565b6040600081812086825260060160205290812060010154611685918b918b918b918b918a918190611b629085610d20565b95505b610ef1565b60008611156115d957505050600095865250506001602081815260408087209587529481528486206007810180548085019091558752600601905292909320908155908101919091556002018054600160a060020a03191633179055565b60008412156116fd576000945061173a565b611737898989898860008581526001602081815260408084208885528252808420858552600401909152822001548190611c449085610d20565b95505b610c0b565b509499939850929650505050505050565b600083111561178e57829350835082878681518110156100025760209081029091010152855182908790879081101561000257602090810290910101525b600194909401936109a5565b6127108310156117d957829350835082878681518110156100025760209081029091010152855182908790879081101561000257602090810290910101525b60019490940193610186565b505050565b600192909201916106b4565b5060005b6001600050600084815260200190815260200160002060005060000160005060008381526020019081526020016000206000506007016000505481101561191a5733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600601600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a031614156119125760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506006016000506000838152602001908152602001600020600050600101600050819055505b6001016117fa565b600191909101906106c3565b5060005b60016000506000848152602001908152602001600020600050600001600050600083815260200190815260200160002060005060070160005054811015611a4a5733600160a060020a0316600160005060008581526020019081526020016000206000506000016000506000848152602001908152602001600020600050600601600050600083815260200190815260200160002060005060020160009054906101000a9004600160a060020a0316600160a060020a03161415611a425760006001600050600085815260200190815260200160002060005060000160005060008481526020019081526020016000206000506006016000506000838152602001908152602001600020600050600101600050819055505b60010161192a565b60019190910190610d7c565b50929998505050505050505050565b6000839003909401935b60019390930192611296565b509295945050505050565b6000839003909401935b60019390930192610800565b5080610bd6565b03115b15611b5457600087815260016020818152604080842033600160a060020a039081168652600382018085528387208d885280865284882080548a0190559285528387208a8852600601855283872080549387018054612710958b028690049003905580870180548a90039055600281018054841689528287528589208f8a52875285892080548b90039055905490549092168752909352932090910180549184029290920401905592839003925b8391505b5095945050505050565b60008881526001602090815260408083208a8452825280832087845260060190915281205491925090611ba69033908a908a9086906127108288039091020461128e565b611baf33610e89565b03118015611aa65750600087815260016020908152604080832089845282528083208684526006019091528120805460029190910154611c0a91600160a060020a0391909116908a908a90868603906127109088020461128e565b60008981526001602090815260408083208b84528252808320888452600601909152902060020154611aa390600160a060020a0316610e89565b60008881526001602090815260408083208a8452825280832087845260040190915281205491925090611c879033908a908a90868603906127109088020461128e565b611c9033610e89565b03118015611cef5750600087815260016020908152604080832089845282528083208684526004019091528120805460029190910154611da491600160a060020a0391909116908a908a9086906127108288039091020461128e565b03115b15611b5457600087815260016020818152604080842033600160a060020a039081168652600382018085528387208d885280865284882080548a900390559285528387208a8852600401855283872080549387018054612710958b0286900401905580870180548a90039055600281018054841689528287528589208f8a52875285892080548b0190559054905490921687529093529320909101805491840292909204900390559283900392839150611b58565b60008981526001602090815260408083208b84528252808320888452600401909152902060020154611cec90600160a060020a0316610e8956","info":{"source":"contract Market {\n\n  address admin = 0x18e79a47d8a58bef5aaecbba85ea1420649c64a8;\n\n  struct Order {\n    uint price;\n    uint size;\n    address user;\n  }\n  struct Option {\n    uint id;\n    bytes32 factHash;\n    address ethAddr;\n    uint strike;\n    mapping(uint => Order) buyOrders;\n    uint numBuyOrders;\n    mapping(uint => Order) sellOrders;\n    uint numSellOrders;\n  }\n  struct Position {\n    mapping(uint => int) positions;\n    int cash;\n  }\n  struct OptionChain {\n    mapping(uint => Option) options;\n    uint numOptions;\n    bool expired;\n    mapping(address => Position) positions;\n  }\n  mapping(uint => OptionChain) optionChains;\n  uint numOptionChains;\n  struct Account {\n    address user;\n    uint capital;\n  }\n  mapping(uint => Account) accounts;\n  uint numAccounts;\n  mapping(address => uint) accountIDs;\n\n  function addFunds() {\n    if (accountIDs[msg.sender]>0) {\n      accounts[accountIDs[msg.sender]].capital += msg.value;\n    } else {\n      uint accountID = ++numAccounts;\n      accounts[accountID].user = msg.sender;\n      accounts[accountID].capital += msg.value;\n      accountIDs[msg.sender] = accountID;\n    }\n  }\n\n  function getFunds(address user) constant returns(uint) {\n    if (accountIDs[user]>0) {\n      return accounts[accountIDs[user]].capital;\n    } else {\n      return 0;\n    }\n  }\n\n  function getAvailableFunds(address user) constant returns(uint) {\n    if (accountIDs[user]>0) {\n      return accounts[accountIDs[user]].capital - getMaxLoss(user);\n    } else {\n      return 0;\n    }\n  }\n\n  function expire(uint optionChainID, uint8[] v, bytes32[] r, bytes32[] s, uint256[] value) {\n    bool allSigned = true;\n    for (uint optionID=0; optionID<optionChains[optionChainID].numOptions; optionID++) {\n      var hash = sha256(optionChains[optionChainID].options[optionID].factHash, value[optionID]);\n      var signerAddress = ecrecover(hash, v[optionID], r[optionID], s[optionID]);\n      if (signerAddress != optionChains[optionChainID].options[optionID].ethAddr) {\n        allSigned = false;\n      }\n    }\n    if (allSigned) {\n      for (optionID=0; optionID<optionChains[optionChainID].numOptions; optionID++) {\n        for (uint accountID=0; accountID<numAccounts; accountID++) {\n          int result = optionChains[optionChainID].positions[accounts[accountID].user].cash;\n          for (uint j=0; j<optionChains[optionChainID].numOptions; j++) {\n            result += (int(value[j]) * optionChains[optionChainID].positions[accounts[accountID].user].positions[j]);\n          }\n          accounts[accountID].capital = uint(int(accounts[accountID].capital) + result);\n        }\n      }\n      optionChains[optionChainID].expired = true;\n    }\n  }\n\n  function addOptionChain(uint[] ids, uint[] strikes, bytes32[] factHashes, address[] ethAddrs) {\n    if (msg.sender==admin) {\n      var optionChainID = numOptionChains++;\n      OptionChain optionChain = optionChains[optionChainID];\n      optionChain.expired = false;\n      for (uint i=0; i < strikes.length; i++) {\n        var optionID = optionChain.numOptions++;\n        Option option = optionChain.options[optionID];\n        option.id = ids[i];\n        option.strike = strikes[i];\n        option.factHash = factHashes[i];\n        option.ethAddr = ethAddrs[i];\n      }\n    }\n  }\n\n  function getNumOptionChains() constant returns(uint) {\n    return numOptionChains;\n  }\n  function getNumOptions(uint optionChainID) constant returns(uint) {\n    return optionChains[optionChainID].numOptions;\n  }\n  function getOption(uint optionChainID, uint optionID) constant returns(uint, uint, bytes32, address) {\n    return (optionChains[optionChainID].options[optionID].id, optionChains[optionChainID].options[optionID].strike, optionChains[optionChainID].options[optionID].factHash, optionChains[optionChainID].options[optionID].ethAddr);\n  }\n  function getPosition(uint optionChainID, uint optionID, address user) constant returns(int) {\n    return optionChains[optionChainID].positions[user].positions[optionID];\n  }\n  function getCash(uint optionChainID, address user) constant returns(int) {\n    return optionChains[optionChainID].positions[user].cash;\n  }\n\n  function placeBuyOrder(uint optionChainID, uint optionID, uint price, uint size) {\n    if (size % 10000 != 0) {\n      size -= size % 10000;\n    }\n    bool foundMatch = true;\n    while (foundMatch && size>0) {\n      int256 bestPriceID = -1;\n      for (uint256 i=0; i<optionChains[optionChainID].options[optionID].numSellOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].sellOrders[i].price<=price && optionChains[optionChainID].options[optionID].sellOrders[i].size>0 && (bestPriceID<0 || optionChains[optionChainID].options[optionID].sellOrders[i].price<optionChains[optionChainID].options[optionID].sellOrders[uint(bestPriceID)].price)) {\n          bestPriceID = int(i);\n        }\n      }\n      if (bestPriceID<0) {\n        foundMatch = false;\n      } else {\n        size = orderMatchBuy(optionChainID, optionID, price, size, uint(bestPriceID));\n      }\n    }\n    if (size>0) {\n      uint orderID = optionChains[optionChainID].options[optionID].numBuyOrders++;\n      Order order = optionChains[optionChainID].options[optionID].buyOrders[orderID];\n      order.price = price;\n      order.size = size;\n      order.user = msg.sender;\n    }\n  }\n\n  function placeSellOrder(uint optionChainID, uint optionID, uint price, uint size) {\n    if (size % 10000 != 0) {\n      size -= size % 10000;\n    }\n    bool foundMatch = true;\n    while (foundMatch && size>0) {\n      int256 bestPriceID = -1;\n      for (uint256 i=0; i<optionChains[optionChainID].options[optionID].numBuyOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].buyOrders[i].price>=price && optionChains[optionChainID].options[optionID].buyOrders[i].size>0 && (bestPriceID<0 || optionChains[optionChainID].options[optionID].buyOrders[i].price>optionChains[optionChainID].options[optionID].buyOrders[uint(bestPriceID)].price)) {\n          bestPriceID = int(i);\n        }\n      }\n      if (bestPriceID<0) {\n        foundMatch = false;\n      } else {\n        size = orderMatchSell(optionChainID, optionID, price, size, uint(bestPriceID));\n      }\n    }\n    if (size>0) {\n      uint orderID = optionChains[optionChainID].options[optionID].numSellOrders++;\n      Order order = optionChains[optionChainID].options[optionID].sellOrders[orderID];\n      order.price = price;\n      order.size = size;\n      order.user = msg.sender;\n    }\n  }\n\n  function orderMatchBuy(uint optionChainID, uint optionID, uint price, uint size, uint bestPriceID) private returns(uint) {\n    uint sizeChange = min(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].size, size);\n    if (getFunds(msg.sender)-getMaxLossAfterTrade(msg.sender, optionChainID, optionID, int(sizeChange), int(-sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000))>0 && getFunds(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user)-getMaxLossAfterTrade(optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user, optionChainID, optionID, int(-sizeChange), int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000))>0) {\n      size -= sizeChange;\n      optionChains[optionChainID].positions[msg.sender].positions[optionID] += int(sizeChange);\n      optionChains[optionChainID].positions[msg.sender].cash -= int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000);\n      optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].size -= sizeChange;\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user].positions[optionID] -= int(sizeChange);\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].user].cash += int(sizeChange * optionChains[optionChainID].options[optionID].sellOrders[bestPriceID].price / 10000);\n    }\n    return size;\n  }\n\n  function orderMatchSell(uint optionChainID, uint optionID, uint price, uint size, uint bestPriceID) private returns(uint) {\n    uint sizeChange = min(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].size, size);\n    if (getFunds(msg.sender)-getMaxLossAfterTrade(msg.sender, optionChainID, optionID, int(-sizeChange), int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000))>0 && getFunds(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user)-getMaxLossAfterTrade(optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user, optionChainID, optionID, int(sizeChange), int(-sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000))>0) {\n      size -= sizeChange;\n      optionChains[optionChainID].positions[msg.sender].positions[optionID] -= int(sizeChange);\n      optionChains[optionChainID].positions[msg.sender].cash += int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000);\n      optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].size -= sizeChange;\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user].positions[optionID] += int(sizeChange);\n      optionChains[optionChainID].positions[optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].user].cash -= int(sizeChange * optionChains[optionChainID].options[optionID].buyOrders[bestPriceID].price / 10000);\n    }\n    return size;\n  }\n\n  function getOptionBuyOrders(uint optionChainID, uint optionID) constant returns(uint[], uint[]) {\n    uint[] memory buyPrices = new uint[](3);\n    uint[] memory buySizes = new uint[](3);\n    uint z = 0;\n    uint bestLevel = 10000;\n    while (z<3) {\n      uint watermark = 0;\n      uint size = 0;\n      for (uint i=0; i<optionChains[optionChainID].options[optionID].numBuyOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].buyOrders[i].size>0 && optionChains[optionChainID].options[optionID].buyOrders[i].price>=watermark && optionChains[optionChainID].options[optionID].buyOrders[i].price<bestLevel) {\n          if (optionChains[optionChainID].options[optionID].buyOrders[i].price>watermark) {\n            size = 0;\n            watermark = optionChains[optionChainID].options[optionID].buyOrders[i].price;\n          }\n          size += optionChains[optionChainID].options[optionID].buyOrders[i].size;\n        }\n      }\n      if (watermark>0) {\n        bestLevel = watermark;\n        buyPrices[z] = watermark;\n        buySizes[z] = size;\n      }\n      z = z + 1;\n    }\n    return (buyPrices, buySizes);\n  }\n\n  function getOptionSellOrders(uint optionChainID, uint optionID) constant returns(uint[], uint[]) {\n    uint[] memory sellPrices = new uint[](3);\n    uint[] memory sellSizes = new uint[](3);\n    uint z = 0;\n    uint bestLevel = 0;\n    while (z<3) {\n      uint watermark = 10000;\n      uint size = 0;\n      for (uint i=0; i<optionChains[optionChainID].options[optionID].numSellOrders; i++) {\n        if (optionChains[optionChainID].options[optionID].sellOrders[i].size>0 && optionChains[optionChainID].options[optionID].sellOrders[i].price<=watermark && optionChains[optionChainID].options[optionID].sellOrders[i].price>bestLevel) {\n          if (optionChains[optionChainID].options[optionID].sellOrders[i].price<watermark) {\n            size = 0;\n            watermark = optionChains[optionChainID].options[optionID].sellOrders[i].price;\n          }\n          size += optionChains[optionChainID].options[optionID].sellOrders[i].size;\n        }\n      }\n      if (watermark<10000) {\n        bestLevel = watermark;\n        sellPrices[z] = watermark;\n        sellSizes[z] = size;\n      }\n      z = z + 1;\n    }\n    return (sellPrices, sellSizes);\n  }\n\n  function cancelOrders() {\n    for (uint optionChainID=0; optionChainID<numOptionChains; optionChainID++) {\n      for (uint i=0; i<optionChains[optionChainID].numOptions; i++) {\n        for (uint j=0; j<optionChains[optionChainID].options[i].numBuyOrders; j++) {\n          if (optionChains[optionChainID].options[i].buyOrders[j].user==msg.sender) {\n            optionChains[optionChainID].options[i].buyOrders[j].size = 0;\n          }\n        }\n        for (j=0; j<optionChains[optionChainID].options[i].numSellOrders; j++) {\n          if (optionChains[optionChainID].options[i].sellOrders[j].user==msg.sender) {\n            optionChains[optionChainID].options[i].sellOrders[j].size = 0;\n          }\n        }\n      }\n    }\n  }\n\n  function cancelOrdersOnChain(uint optionChainID) {\n    for (uint i=0; j<optionChains[optionChainID].numOptions; i++) {\n      for (uint j=0; j<optionChains[optionChainID].options[i].numBuyOrders; j++) {\n        if (optionChains[optionChainID].options[i].buyOrders[j].user==msg.sender) {\n          optionChains[optionChainID].options[i].buyOrders[j].size = 0;\n        }\n      }\n      for (j=0; j<optionChains[optionChainID].options[i].numSellOrders; j++) {\n        if (optionChains[optionChainID].options[i].sellOrders[j].user==msg.sender) {\n          optionChains[optionChainID].options[i].sellOrders[j].size = 0;\n        }\n      }\n    }\n  }\n\n  function getMaxLossAfterTrade(address user, uint optionChainID, uint optionID, int positionChange, int cashChange) constant returns(uint) {\n    uint totalMaxLoss = 0;\n    for (uint i=0; i<numOptionChains; i++) {\n      if (optionChains[i].expired == false) {\n        int maxLoss = 0;\n        int pnl = optionChains[i].positions[user].cash;\n        if (pnl<maxLoss) {\n          maxLoss = pnl;\n        }\n        if (i==optionChainID) {\n          pnl += cashChange;\n        }\n        for (uint j=0; j<optionChains[i].numOptions; j++) {\n          pnl += optionChains[i].positions[user].positions[j];\n          if (i==optionChainID && j==optionID) {\n            pnl += positionChange;\n          }\n          if (pnl<maxLoss) {\n            maxLoss = -pnl;\n          }\n        }\n        totalMaxLoss += uint(-maxLoss);\n      }\n    }\n    return totalMaxLoss;\n  }\n\n  function getMaxLoss(address user) constant returns(uint) {\n    uint totalMaxLoss = 0;\n    for (uint i=0; i<numOptionChains; i++) {\n      if (optionChains[i].expired == false) {\n        int maxLoss = 0;\n        int pnl = optionChains[i].positions[user].cash;\n        if (pnl<maxLoss) {\n          maxLoss = pnl;\n        }\n        for (uint j=0; j<optionChains[i].numOptions; j++) {\n          pnl += optionChains[i].positions[user].positions[j];\n          if (pnl<maxLoss) {\n            maxLoss = pnl;\n          }\n        }\n        totalMaxLoss += uint(-maxLoss);\n      }\n    }\n    return totalMaxLoss;\n  }\n\n  function min(uint a, uint b) constant returns(uint) {\n    if (a<b) {\n      return a;\n    } else {\n      return b;\n    }\n  }\n  function max(uint a, uint b) constant returns(uint) {\n    if (a>b) {\n      return a;\n    } else {\n      return b;\n    }\n  }\n}\n","language":"Solidity","languageVersion":"0.2.0","compilerVersion":"0.2.0","compilerOptions":"--bin --abi --userdoc --devdoc --add-std --optimize -o /var/folders/sj/bz257rsj0w1g7cpjjycd7wpw0000gn/T/solc009766768","abiDefinition":[{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOptionSellOrders","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOption","outputs":[{"name":"","type":"uint256"},{"name":"","type":"uint256"},{"name":"","type":"bytes32"},{"name":"","type":"address"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"v","type":"uint8[]"},{"name":"r","type":"bytes32[]"},{"name":"s","type":"bytes32[]"},{"name":"value","type":"uint256[]"}],"name":"expire","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"user","type":"address"}],"name":"getPosition","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[],"name":"cancelOrders","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getMaxLoss","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"max","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"}],"name":"getOptionBuyOrders","outputs":[{"name":"","type":"uint256[]"},{"name":"","type":"uint256[]"}],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"user","type":"address"}],"name":"getCash","outputs":[{"name":"","type":"int256"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"price","type":"uint256"},{"name":"size","type":"uint256"}],"name":"placeSellOrder","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"a","type":"uint256"},{"name":"b","type":"uint256"}],"name":"min","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[],"name":"addFunds","outputs":[],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"}],"name":"cancelOrdersOnChain","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getAvailableFunds","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[],"name":"getNumOptionChains","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"}],"name":"getFunds","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"price","type":"uint256"},{"name":"size","type":"uint256"}],"name":"placeBuyOrder","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"optionChainID","type":"uint256"}],"name":"getNumOptions","outputs":[{"name":"","type":"uint256"}],"type":"function"},{"constant":false,"inputs":[{"name":"ids","type":"uint256[]"},{"name":"strikes","type":"uint256[]"},{"name":"factHashes","type":"bytes32[]"},{"name":"ethAddrs","type":"address[]"}],"name":"addOptionChain","outputs":[],"type":"function"},{"constant":true,"inputs":[{"name":"user","type":"address"},{"name":"optionChainID","type":"uint256"},{"name":"optionID","type":"uint256"},{"name":"positionChange","type":"int256"},{"name":"cashChange","type":"int256"}],"name":"getMaxLossAfterTrade","outputs":[{"name":"","type":"uint256"}],"type":"function"}],"userDoc":{"methods":{}},"developerDoc":{"methods":{}}}}}